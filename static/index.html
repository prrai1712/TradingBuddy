<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TradingBuddy</title>

  <!-- Premium Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- ChartJS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #f4f6fa;
      --card-bg: #ffffff;
      --primary: #2d6cdf;
      --primary-dark: #1f4faa;
      --border: #e3e6ea;
      --text: #1a1c1f;
      --muted: #6c757d;
      --radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    body {
      margin: 0;
      background: var(--bg);
      font-family: "Inter", sans-serif;
      color: var(--text);
    }

    /* --- NAVBAR --- */
    nav {
      width: 100%;
      background: #ffffff;
      padding: 16px 32px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    nav .logo {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: -0.5px;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      padding: 32px 20px;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 26px;
      font-weight: 600;
      text-align: center;
    }

    /* --- CONTROL PANEL --- */
    .controls {
      background: var(--card-bg);
      padding: 22px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 30px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--muted);
    }

    select, input {
      width: 100%;
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: var(--card-bg);
      font-size: 14px;
      transition: 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(45,108,223,0.15);
    }

    .button-row {
      grid-column: 1 / -1;
      display: flex;
      gap: 14px;
      margin-top: 5px;
    }

    button {
      padding: 11px 20px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.3px;
      transition: 0.2s;
      font-size: 14px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }
    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--border);
      color: #333;
    }
    .btn-secondary:hover {
      background: #d4d7db;
    }

    /* --- RESULT TEXT --- */
    #result {
      margin: 10px 0 20px;
      font-weight: 500;
      color: var(--primary);
      text-align: center;
    }

    /* --- CHARTS LAYOUT --- */
    .charts-wrapper {
      display: flex;
      gap: 20px;
    }

    .chart-box {
      flex: 1;
      background: var(--card-bg);
      padding: 22px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .chart-box h3 {
      text-align: center;
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 16px;
      color: var(--text);
    }

    @media (max-width: 900px) {
      .controls {
        grid-template-columns: 1fr;
      }
      .charts-wrapper {
        flex-direction: column;
      }
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav>
    <div class="logo">TradingBuddy</div>
  </nav>

  <div class="container">

    <h2>Options Dashboard — CE/PE + NIFTY Spot</h2>

    <!-- CONTROL PANEL -->
    <div class="controls">
      <div>
        <label>Symbol</label>
        <select id="symbol" onchange="loadExpiryDates()">
          <option value="NIFTY">NIFTY</option>
          <option value="BANKNIFTY">BANKNIFTY</option>
        </select>
      </div>

      <div>
        <label>Year</label>
        <select id="year" onchange="loadExpiryDates()"></select>
      </div>

      <div>
        <label>Expiry</label>
        <select id="expiry" onchange="autoDates()"></select>
      </div>

      <div>
        <label>Strike Price</label>
        <input id="strike" type="number" placeholder="e.g. 24000">
      </div>

      <div>
        <label>From Date</label>
        <input id="fromDate" type="text" placeholder="dd-mm-yyyy">
      </div>

      <div>
        <label>To Date</label>
        <input id="toDate" type="text" placeholder="dd-mm-yyyy">
      </div>

      <div class="button-row">
        <button class="btn-primary" onclick="getPrice()">Load Charts</button>
        <button class="btn-secondary" onclick="resetControls()">Reset</button>
      </div>
    </div>

    <div id="result"></div>

    <!-- CHARTS -->
    <div class="charts-wrapper">

      <div class="chart-box">
        <h3>CE + PE Combined (Close)</h3>
        <canvas id="combinedChart" height="220"></canvas>
      </div>

      <div class="chart-box">
        <h3>NIFTY Spot (Close)</h3>
        <canvas id="niftyChart" height="220"></canvas>
      </div>

    </div>

  </div>

  <!-- YOUR EXISTING JS — UNTOUCHED -->
  <script>
    /* YOUR ENTIRE EXISTING JAVASCRIPT STAYS SAME — I did NOT modify anything */
    /* Pasting the full JS exactly as-is: */
    
    let combinedChart = null;
    let niftyChart = null;

    function loadYears() {
      const y = document.getElementById("year");
      y.innerHTML = "";
      const thisYear = new Date().getFullYear();
      for (let i = 2015; i <= thisYear + 1; i++) {
        const o = document.createElement("option");
        o.value = i;
        o.textContent = i;
        y.appendChild(o);
      }
      y.value = thisYear;
    }

    async function loadExpiryDates() {
      const symbol = document.getElementById("symbol").value;
      const year = document.getElementById("year").value;

      try {
        const res = await fetch(
          `expiry_dates?symbol=${encodeURIComponent(symbol)}&year=${encodeURIComponent(year)}`
        );
        const list = await res.json();
        const drop = document.getElementById("expiry");
        drop.innerHTML = "";

        const mmMap = {
          JAN: "01",
          FEB: "02",
          MAR: "03",
          APR: "04",
          MAY: "05",
          JUN: "06",
          JUL: "07",
          AUG: "08",
          SEP: "09",
          OCT: "10",
          NOV: "11",
          DEC: "12",
        };

        list.forEach((exp) => {
          const [d, mmm, y] = exp.split("-");
          const mm = mmMap[mmm] || "01";
          const formatted = `${y}-${mm}-${d}`;
          const opt = document.createElement("option");
          opt.value = formatted;
          opt.textContent = exp;
          drop.appendChild(opt);
        });

        autoDates();
      } catch (err) {
        console.error(err);
        document.getElementById("result").innerText = "Failed to load expiry dates";
      }
    }

    function fmtDate(d) {
      return `${String(d.getDate()).padStart(2, "0")}-${String(
        d.getMonth() + 1
      ).padStart(2, "0")}-${d.getFullYear()}`;
    }

    function autoDates() {
      const expiry = document.getElementById("expiry").value;
      if (!expiry) return;
      const e = new Date(expiry);
      const from = new Date(e);
      from.setDate(from.getDate() - 30);
      document.getElementById("fromDate").value = fmtDate(from);
      document.getElementById("toDate").value = fmtDate(e);
    }

    function resetControls() {
      loadYears();
      loadExpiryDates();
      document.getElementById("strike").value = "";
      document.getElementById("result").innerText = "";
    }

    async function safeFetch(url) {
      const r = await fetch(url);
      let data;
      try {
        data = await r.json();
      } catch (e) {
        data = { error: "Invalid JSON" };
      }
      if (!r.ok) {
        return { error: data || `HTTP ${r.status}` };
      }
      return data;
    }

    async function getPrice() {
      document.getElementById("result").innerText = "Loading...";

      const baseParams = {
        symbol: document.getElementById("symbol").value,
        expiry: document.getElementById("expiry").value,
        strike: document.getElementById("strike").value,
        fromDate: document.getElementById("fromDate").value,
        toDate: document.getElementById("toDate").value,
      };

      if (!baseParams.fromDate || !baseParams.toDate) {
        document.getElementById("result").innerText = "Please enter a valid date range";
        return;
      }

      try {
        const ceURL = new URL("open_price", window.location.origin);
        ceURL.search = new URLSearchParams({ ...baseParams, optionType: "CE" });

        const peURL = new URL("open_price", window.location.origin);
        peURL.search = new URLSearchParams({ ...baseParams, optionType: "PE" });

        const [ceResp, peResp] = await Promise.all([safeFetch(ceURL), safeFetch(peURL)]);

        if (ceResp.error) {
          document.getElementById("result").innerText = "CE error: " + JSON.stringify(ceResp.error);
          return;
        }
        if (peResp.error) {
          document.getElementById("result").innerText = "PE error: " + JSON.stringify(peResp.error);
          return;
        }

        const ceData = Array.isArray(ceResp) ? ceResp : [];
        const peData = Array.isArray(peResp) ? peResp : [];

        if (!ceData.length && !peData.length) {
          document.getElementById("result").innerText = "No option data found";
          return;
        }

        let labels = [];
        if (ceData.length) labels = ceData.map((x) => x.date).reverse();
        else if (peData.length) labels = peData.map((x) => x.date).reverse();

        const cePrices = ceData.length ? ceData.map((x) => x.close).reverse() : labels.map(() => null);
        const pePrices = peData.length ? peData.map((x) => x.close).reverse() : labels.map(() => null);

        if (combinedChart) combinedChart.destroy();
        combinedChart = new Chart(document.getElementById("combinedChart"), {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "CE Close",
                data: cePrices,
                borderColor: "rgb(10,102,194)",
                tension: 0.25,
              },
              {
                label: "PE Close",
                data: pePrices,
                borderColor: "rgb(194,34,34)",
                tension: 0.25,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "top" } },
          },
        });

        const nsURL = new URL("nifty_spot", window.location.origin);
        nsURL.search = new URLSearchParams({
          symbol: baseParams.symbol,
          fromDate: baseParams.fromDate,
          toDate: baseParams.toDate,
        });

        const spotResp = await safeFetch(nsURL);
        if (spotResp.error) {
          document.getElementById("result").innerText =
            "Spot error: " + JSON.stringify(spotResp.error);
          return;
        }

        const spotData = Array.isArray(spotResp) ? spotResp : [];
        const spotLabels = spotData.map((x) => x.date);
        const spotPrices = spotData.map((x) => x.close);

        if (niftyChart) niftyChart.destroy();
        niftyChart = new Chart(document.getElementById("niftyChart"), {
          type: "line",
          data: {
            labels: spotLabels,
            datasets: [
              {
                label: "Spot Close",
                data: spotPrices,
                borderColor: "rgb(34,163,90)",
                tension: 0.25,
              },
            ],
          },
        });

        document.getElementById("result").innerText = "Charts Loaded ✔";
      } catch (err) {
        console.error(err);
        document.getElementById("result").innerText = "Unexpected error — check console.";
      }
    }

    window.onload = function () {
      loadYears();
      loadExpiryDates();
    };
  </script>

</body>
</html>


